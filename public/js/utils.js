/* ===== UTILITAIRES ET STOCKAGE ===== */

// ===== CONFIGURATION ET VARIABLES GLOBALES =====
// Configuration de l'API - peut √™tre surcharg√©e via window.__APP_CONFIG__
const SERVER_URL = (typeof window !== 'undefined' && window.__APP_CONFIG__?.SERVER_URL) || 'http://localhost:3000';

// Mode de stockage actuel (online/offline)
let STORAGE_MODE = navigator.onLine ? 'online' : 'local';

// Debounce pour √©viter les requ√™tes multiples
let saveTimeout = null;
const SAVE_DEBOUNCE_DELAY = 1000; // 1 seconde

// ===== GESTION DES MODES ONLINE/OFFLINE =====
// D√©tection automatique des changements de connectivit√©
window.addEventListener('online', () => {
    console.log('üåê Connexion r√©tablie - passage en mode online');
    STORAGE_MODE = 'online';
    showStatusMessage('Connexion r√©tablie - synchronisation en cours...', 'info');
    
    // Tentative de synchronisation automatique
    setTimeout(() => {
        syncWithServer();
    }, 500);
});

window.addEventListener('offline', () => {
    console.log('üì¥ Connexion perdue - passage en mode local');
    STORAGE_MODE = 'local';
    showStatusMessage('Mode hors-ligne activ√© - donn√©es sauvegard√©es localement', 'warning');
});

// ===== FONCTIONS DE SYNCHRONISATION =====

// Fonction pour charger les donn√©es suppl√©mentaires d'un clan depuis le serveur
async function loadClanAdditionalData(clanTag) {
    try {
        if (!clanTag) return null;
        
        const cleanTag = clanTag.replace('#', '');
        console.log('üì° Chargement des donn√©es suppl√©mentaires depuis le serveur...');
        
        const response = await fetch(`${SERVER_URL}/api/clan/${cleanTag}/members`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const clanData = await response.json();
            console.log(`‚úÖ Donn√©es suppl√©mentaires charg√©es pour le clan ${cleanTag}`);
            
            // Sauvegarder en local comme backup
            localStorage.setItem(`clanAdditionalData_${cleanTag}`, JSON.stringify(clanData));
            
            return clanData;
        } else {
            throw new Error(`Erreur serveur: ${response.status}`);
        }
    } catch (error) {
        console.error('‚ùå Erreur lors du chargement des donn√©es suppl√©mentaires:', error);
        showStatusMessage('Erreur de chargement des donn√©es suppl√©mentaires - utilisation des donn√©es locales', 'warning');
        
        // Fallback vers localStorage
        const cleanTag = clanTag.replace('#', '');
        const localData = localStorage.getItem(`clanAdditionalData_${cleanTag}`);
        return localData ? JSON.parse(localData) : { clanTag: cleanTag, members: {} };
    }
}

// Fonction pour charger les donn√©es suppl√©mentaires depuis le localStorage
function loadStoredClanAdditionalData(clanTag) {
    const cleanTag = clanTag.replace('#', '');
    const stored = localStorage.getItem(`clanAdditionalData_${cleanTag}`);
    return stored ? JSON.parse(stored) : { clanTag: cleanTag, members: {} };
}

// Fonction pour sauvegarder les donn√©es suppl√©mentaires d'un membre
async function saveMemberAdditionalData(memberTag, memberData) {
    try {
        console.log('üîß saveMemberAdditionalData appel√©e:', { memberTag, memberData, currentClanTag, STORAGE_MODE, navigatorOnLine: navigator.onLine });
        
        if (!currentClanTag) {
            console.warn('‚ùå Aucun clan s√©lectionn√© pour la sauvegarde');
            return;
        }

        // Debounce pour √©viter les requ√™tes multiples
        if (saveTimeout) {
            console.log('‚è∞ Annulation du timeout pr√©c√©dent');
            clearTimeout(saveTimeout);
        }
        
        console.log('‚è∞ Programmation de la sauvegarde dans 1 seconde...');
        saveTimeout = setTimeout(async () => {
            if (STORAGE_MODE === 'online' && navigator.onLine) {
                console.log('üì° Sauvegarde des donn√©es suppl√©mentaires sur le serveur...');
                
                const cleanClanTag = currentClanTag.replace('#', '');
                const cleanMemberTag = memberTag.replace('#', '');
                
                console.log('üåê Envoi vers le serveur:', {
                    url: `${SERVER_URL}/api/clan/${cleanClanTag}/member/${cleanMemberTag}`,
                    data: memberData
                });
                
                const response = await fetch(`${SERVER_URL}/api/clan/${cleanClanTag}/member/${cleanMemberTag}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(memberData)
                });
                
                console.log('üì° R√©ponse du serveur:', response.status, response.statusText);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`‚úÖ Donn√©es du membre ${cleanMemberTag} sauvegard√©es:`, result);
                    
                    // Mettre √† jour clanMembers avec les nouvelles donn√©es
                    const member = clanMembers.find(m => m.tag === memberTag);
                    if (member) {
                        member.comments = memberData.comment || '';
                        member.participations = memberData.participations || {};
                        console.log('üîÑ clanMembers mis √† jour pour:', memberTag);
                    }
                    
                    // Sauvegarder aussi en local comme backup
                    saveMemberDataToLocal(memberTag, memberData);
                    
                    showStatusMessage('Donn√©es du membre sauvegard√©es', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur serveur:', response.status, errorText);
                    throw new Error(`Erreur serveur: ${response.status} - ${errorText}`);
                }
            } else {
                // Mode local ou serveur indisponible
                console.log('üíæ Sauvegarde locale des donn√©es suppl√©mentaires...');
                
                // Mettre √† jour clanMembers m√™me en mode local
                const member = clanMembers.find(m => m.tag === memberTag);
                if (member) {
                    member.comments = memberData.comment || '';
                    member.participations = memberData.participations || {};
                    console.log('üîÑ clanMembers mis √† jour localement pour:', memberTag);
                }
                
                saveMemberDataToLocal(memberTag, memberData);
                showStatusMessage('Donn√©es sauvegard√©es localement', 'info');
            }
        }, SAVE_DEBOUNCE_DELAY);
        
    } catch (error) {
        console.error('‚ùå Erreur lors de la sauvegarde des donn√©es suppl√©mentaires:', error);
        // Fallback vers le localStorage
        saveMemberDataToLocal(memberTag, memberData);
        showStatusMessage('Erreur de sauvegarde - donn√©es sauv√©es localement', 'error');
    }
}

// Fonction pour sauvegarder les donn√©es d'un membre en local
function saveMemberDataToLocal(memberTag, memberData) {
    if (!currentClanTag) return;
    
    const cleanClanTag = currentClanTag.replace('#', '');
    const cleanMemberTag = memberTag.replace('#', '');
    
    // R√©cup√©rer les donn√©es existantes du clan
    let clanData = loadStoredClanAdditionalData(currentClanTag);
    
    // Mettre √† jour les donn√©es du membre
    clanData.members[cleanMemberTag] = {
        ...clanData.members[cleanMemberTag],
        ...memberData,
        lastUpdated: new Date().toISOString()
    };
    
    // Sauvegarder en local
    localStorage.setItem(`clanAdditionalData_${cleanClanTag}`, JSON.stringify(clanData));
}

// Fonction de synchronisation avec le serveur
async function syncWithServer() {
    try {
        if (!navigator.onLine) {
            showStatusMessage('Pas de connexion - synchronisation impossible', 'warning');
            return;
        }
        
        if (!currentClanTag || !clanMembers || clanMembers.length === 0) {
            showStatusMessage('Aucune donn√©e √† synchroniser', 'warning');
            return;
        }
        
        showStatusMessage('Synchronisation en cours...', 'info');
        
        // 1. D'abord sauvegarder les donn√©es locales vers le serveur
        console.log('üì§ Sauvegarde des donn√©es locales vers le serveur...');
        await saveMembers();
        
        // 2. Ensuite charger les donn√©es depuis le serveur pour v√©rifier
        console.log('üì• Chargement des donn√©es depuis le serveur...');
        const serverMembers = await loadMembers();
        
        console.log('‚úÖ Synchronisation termin√©e');
        showStatusMessage('Synchronisation r√©ussie', 'success');
        
    } catch (error) {
        console.error('‚ùå Erreur de synchronisation:', error);
        showStatusMessage('Erreur de synchronisation', 'error');
    }
}

// Fonction pour sauvegarder les membres dans le localStorage (fallback)
function saveMembersToStorage() {
    localStorage.setItem('clanMembers', JSON.stringify(clanMembers));
}

// Fonction pour charger les membres depuis le serveur (manquante)
async function loadMembers() {
    try {
        if (!currentClanTag) {
            console.warn('Aucun clan s√©lectionn√©');
            return [];
        }
        
        const cleanTag = currentClanTag.replace('#', '');
        console.log('üì° Chargement des membres depuis le serveur...');
        
        const response = await fetch(`${SERVER_URL}/api/clan/${cleanTag}/members`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log(`‚úÖ ${Object.keys(data.members || {}).length} membres charg√©s depuis le serveur`);
            return data.members || {};
        } else {
            throw new Error(`Erreur serveur: ${response.status}`);
        }
    } catch (error) {
        console.error('‚ùå Erreur lors du chargement des membres:', error);
        // Fallback vers localStorage
        return loadStoredMembers();
    }
}

// Fonction pour sauvegarder les membres sur le serveur (manquante)
async function saveMembers() {
    try {
        if (!currentClanTag || !clanMembers || clanMembers.length === 0) {
            console.warn('Aucune donn√©e √† sauvegarder');
            return;
        }
        
        const cleanTag = currentClanTag.replace('#', '');
        console.log('üì° Sauvegarde des membres sur le serveur...');
        
        // Pr√©parer les donn√©es pour le serveur
        const membersData = {};
        clanMembers.forEach(member => {
            const cleanMemberTag = member.tag.replace('#', '');
            membersData[cleanMemberTag] = {
                name: member.name,
                tag: member.tag,
                level: member.level,
                trophies: member.trophies,
                role: member.role,
                donations: member.donations || 0,
                donationsReceived: member.donationsReceived || 0,
                comment: member.comments || '',
                participations: member.participations || {
                    gdc: false,
                    jdc: false,
                    league: false,
                    raids: false
                },
                lastUpdated: new Date().toISOString()
            };
        });
        
        const response = await fetch(`${SERVER_URL}/api/clan/${cleanTag}/members`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ members: membersData })
        });
        
        if (response.ok) {
            console.log(`‚úÖ ${clanMembers.length} membres sauvegard√©s sur le serveur`);
            showStatusMessage('Donn√©es synchronis√©es avec le serveur', 'success');
        } else {
            throw new Error(`Erreur serveur: ${response.status}`);
        }
    } catch (error) {
        console.error('‚ùå Erreur lors de la sauvegarde des membres:', error);
        // Fallback vers localStorage
        saveMembersToStorage();
        showStatusMessage('Erreur de synchronisation - donn√©es sauv√©es localement', 'warning');
    }
}

// Fonction pour charger les membres depuis le localStorage
function loadStoredMembers() {
    const stored = localStorage.getItem('clanMembers');
    if (stored) {
        const parsedData = JSON.parse(stored);
        // Si c'est un tableau (ancien format), le retourner tel quel
        if (Array.isArray(parsedData)) {
            return parsedData;
        }
        // Si c'est un objet avec des membres, convertir en tableau
        if (parsedData.members && typeof parsedData.members === 'object') {
            return Object.values(parsedData.members);
        }
        // Fallback
        return [];
    }
    return [];
}

// Fonction pour afficher un message de statut
function showStatusMessage(message, type = 'success') {
    // Supprimer les messages existants
    const existingMessages = document.querySelectorAll('.status-message');
    existingMessages.forEach(msg => msg.remove());
    
    // Cr√©er le nouveau message
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message ${type}`;
    statusDiv.textContent = message;
    
    // Ajouter des styles CSS si n√©cessaire
    if (!document.querySelector('#status-message-styles')) {
        const style = document.createElement('style');
        style.id = 'status-message-styles';
        style.textContent = `
            .status-message {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease-out;
            }
            .status-message.success { background-color: #10b981; }
            .status-message.error { background-color: #ef4444; }
            .status-message.warning { background-color: #f59e0b; }
            .status-message.info { background-color: #3b82f6; }
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(statusDiv);
    
    // Supprimer automatiquement apr√®s 4 secondes (plus long pour les messages d'info)
    const timeout = type === 'info' ? 5000 : 3000;
    setTimeout(() => {
        if (statusDiv.parentNode) {
            statusDiv.remove();
        }
    }, timeout);
}

// Fonction utilitaire pour formater les tags
function formatTag(tag) {
    return tag.startsWith('#') ? tag : `#${tag}`;
}

// Fonction pour exporter les donn√©es (am√©lior√©e)
function exportData() {
    try {
        if (!clanMembers || clanMembers.length === 0) {
            showStatusMessage('Aucune donn√©e √† exporter', 'warning');
            return;
        }

        // Cr√©er un objet avec m√©tadonn√©es
        const exportData = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            memberCount: clanMembers.length,
            members: clanMembers
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        // G√©n√©rer un nom de fichier avec timestamp
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const filename = `catbreakers-backup-${timestamp}.json`;
        
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        URL.revokeObjectURL(url);
        
        showStatusMessage(`${clanMembers.length} membres export√©s avec succ√®s`, 'success');
        
    } catch (error) {
        console.error('Erreur lors de l\'export:', error);
        showStatusMessage('Erreur lors de l\'exportation des donn√©es', 'error');
    }
}

// Fonction pour importer des donn√©es (am√©lior√©e avec validation)
function importData(event) {
    const file = event.target.files[0];
    if (!file) {
        showStatusMessage('Aucun fichier s√©lectionn√©', 'warning');
        return;
    }

    // V√©rifier la taille du fichier (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        showStatusMessage('Fichier trop volumineux (max 10MB)', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Validation du format des donn√©es
            let members = null;
            
            // Support des anciens formats (tableau direct) et nouveaux formats (avec m√©tadonn√©es)
            if (Array.isArray(importedData)) {
                members = importedData;
            } else if (importedData.members && Array.isArray(importedData.members)) {
                members = importedData.members;
                console.log(`Import depuis backup du ${importedData.exportDate || 'date inconnue'}`);
            } else {
                throw new Error('Format de fichier non reconnu');
            }

            // Validation basique des membres
            if (members.length === 0) {
                throw new Error('Aucun membre trouv√© dans le fichier');
            }

            // Validation de la structure des membres (v√©rification basique)
            const firstMember = members[0];
            if (!firstMember.name && !firstMember.tag) {
                throw new Error('Structure de membre invalide - propri√©t√©s name ou tag manquantes');
            }

            // Confirmation avant import
            const confirmMessage = `Importer ${members.length} membres ? Cela remplacera les donn√©es actuelles.`;
            if (confirm(confirmMessage)) {
                clanMembers = members;
                
                // Sauvegarder selon le mode actuel
                if (STORAGE_MODE === 'online' && navigator.onLine) {
                    saveMembers();
                } else {
                    saveMembersToStorage();
                }
                
                displayMembers();
                showStatusMessage(`${members.length} membres import√©s avec succ√®s`, 'success');
            }
            
        } catch (error) {
            console.error('Erreur lors de l\'import:', error);
            showStatusMessage(`Erreur d'import: ${error.message}`, 'error');
        }
    };
    
    reader.onerror = function() {
        showStatusMessage('Erreur lors de la lecture du fichier', 'error');
    };
    
    reader.readAsText(file);
    
    // R√©initialiser l'input pour permettre le m√™me fichier
    event.target.value = '';
}

// Fonction expos√©e pour l'int√©gration API externe
function saveComment(memberId, data) {
    // Cette fonction peut √™tre surcharg√©e pour envoyer les donn√©es √† un serveur
    console.log('Sauvegarde externe:', memberId, data);
    
    // Exemple d'int√©gration avec une API :
    /*
    fetch('/api/member-comments', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            memberId: memberId,
            comment: data.comment,
            participations: data.participations
        })
    })
    .then(response => response.json())
    .then(result => {
        console.log('Sauvegarde serveur r√©ussie:', result);
    })
    .catch(error => {
        console.error('Erreur sauvegarde serveur:', error);
        showStatusMessage('Erreur lors de la sauvegarde sur le serveur', 'error');
    });
    */
}










